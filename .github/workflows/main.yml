name: CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
    
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤
      run: |
        python -m unittest test_calculator.py -v
    
    - name: –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
        python -m unittest discover -s . -p "test_*.py" -v

  docs:
    name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      run: |
        python -m pip install --upgrade pip
        pip install pydoc-markdown
    
    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      run: |
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        mkdir -p docs
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏–∑ docstrings
        pydoc-markdown -m calculator > docs/calculator.md
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–∞—Ç—É
        echo "# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ Calculator" > docs/README.md
        echo "" >> docs/README.md
        echo "**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** $(date '+%Y-%m-%d %H:%M:%S')" >> docs/README.md
        echo "" >> docs/README.md
        echo "## –û–ø–∏—Å–∞–Ω–∏–µ" >> docs/README.md
        echo "–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å –±–∞–∑–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏." >> docs/README.md
        echo "" >> docs/README.md
        echo "## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è" >> docs/README.md
        cat docs/calculator.md >> docs/README.md
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      id: check_changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add docs/
        
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        fi
    
    - name: –°–æ–∑–¥–∞–Ω–∏–µ Pull Request —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        branch: docs/auto-update-${{ github.run_number }}
        delete-branch: true
        title: "üìö –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        body: |
          ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
          
          –≠—Ç–æ—Ç PR –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω GitHub Actions.
          
          ### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
          - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ docstrings
          - –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${{ github.event.head_commit.timestamp }}
          
          ### –ö–æ–º–º–∏—Ç:
          - SHA: ${{ github.sha }}
          - –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          
          **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º!**
        labels: |
          documentation
          automated
